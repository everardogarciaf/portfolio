WITH calendar AS (    SELECT DISTINCT month_start as month    FROM analytics.calendar)--Aggregate the total monthly $ amount and logo count up for renewal, grouped by marketing direction, industry, etc,monthly_up_for_renewal AS (    SELECT        date_trunc('month', eb.up_for_renewal_date)::DATE AS up_for_renewal_month        , eb.first_contact_direction        , im.mapping2 AS industry -- would like to be able to pull in industry, or at least mapped industry        , eb.is_smb_migration        , eb.auto_renewal_contract_feature        , eb.booking_type_rollup        --if we want to pull in TEAM from salesforce, we should consider adding it here.        --TENURE--        , eb.up_for_renewal_period_segment --your basic beginning to end period segment        --CASH--        , sum(eb.bookings) AS dollars_up_for_renewal                --CHURN--        , COUNT(DISTINCT eb.salesforce_account_id) AS logos_up_for_renewal    FROM {{ ref('ent_bookings_et') }} eb    LEFT JOIN {{ref('industry_mapping_seed')}} im USING (industry)    WHERE 1 = 1    GROUP BY 1, 2, 3, 4, 5, 6, 7--Aggregate the total monthly $ amount and logos renewed, grouped by marketing direction, industry, and several other markers; pull both the financial and operational values), monthly_actual_renewals AS (--WITH financial_renewals AS (    SELECT        date_trunc('month', eb.financial_renewal_date)::DATE AS renewal_month        , 'financial' AS calculation_type --open to better nomenclature; is record_type better?        , eb.first_contact_direction        , im.mapping2 AS industry -- would like to be able to pull in industry, or at least mapped industry        , eb.is_smb_migration        , eb.auto_renewal_contract_feature        , eb.financial_period_segment AS period_segment        --CASH--        , SUM(eb.bookings) AS dollars_renewed        , dollars_upsold -- this is the latest point at which we can do upsell        --CHURN--        , COUNT(DISTINCT eb.salesforce_account_id) AS logos_renewed        , logos_upsold -- this is the latest point at which we can do upsell        -- On-time renewal status, financial and operational from ent_bookings using the is_late/early/on-time flags    FROM {{ ref('ent_bookings_et') }} eb    LEFT JOIN {{ref('industry_mapping_seed')}} im USING (industry)    WHERE 1 = 1        AND eb.booking_type NOT IN ('New Business', 'Upsell - New')    GROUP BY 1, 2, 3, 4, 5, 6, 7    UNION ALL--), operational_renewals AS (    SELECT        date_trunc('month', eb.operational_renewal_date)::DATE AS renewal_month --convert to months if needed, to join on calendar month later        , 'operational' AS calculation_type --open to better nomenclature; is record_type better?        , eb.first_contact_direction        , im.mapping2 AS industry -- would like to be able to pull in industry, or at least mapped industry        , eb.is_smb_migration        , eb.auto_renewal_contract_feature        , eb.operational_period_segment AS period_segment        --CASH--        , SUM(eb.bookings) AS dollars_renewed        , dollars_upsold        --CHURN--        , COUNT(DISTINCT eb.salesforce_account_id) AS logos_renewed        , logos_upsold        -- On-time renewal status, financial and operational from ent_bookings using the is_late/early/on-time flags in ent_bookings_pp    FROM {{ ref('ent_bookings_et') }} eb    LEFT JOIN {{ref('industry_mapping_seed')}} im USING (industry)    WHERE 1 = 1        AND eb.booking_type NOT IN ('New Business', 'Upsell - New')    GROUP BY 1, 2, 3, 4, 5, 6, 7)--Calculate the monthly retention figures based on industry, marketing direction, etc for both financial and operational definitions, both $ and logos-- , monthly_retention AS (    SELECT        c.month        , r.calculation_type        --if we figure it out, we can pull in drill down level here.         , coalesce(ufr.is_smb_migration, r.is_smb_migration) AS is_smb_migration         , coalesce(ufr.industry, r.industry) AS industry        , coalesce(ufr.first_contact_direction, r.first_contact_direction) AS first_contact_direction        , coalesce(ufr.auto_renewal_contract_feature, r.auto_renewal_contract_feature) AS auto_renewal_contract_feature        --if we want to pull in TEAM from salesforce, we should consider adding it here.        --CASH--        , ufr.dollars_up_for_renewal AS dollars_up_for_renewal        , r.dollars_renewed AS dollars_renewed        , r.dollars_upsold AS dollars_upsold        --include dollars churned--     , amount_available_to_renew--     , renewal_amount        --CHURN--        , ufr.logos_up_for_renewal AS logos_up_for_renewal        , r.logos_renewed        , r.logos_upsold        --can we include logos churned? may need to define        --TENURE        , ufr.up_for_renewal_period_segment AS up_for_renewal_period_segment        , r.period_segment AS period_segment        , r.timeliness_of_closing --change name if something better comes up-- Do we need any of the four colums below? I don't see a need for them.--         , ufr.contracts_within_renewal AS contracts_avaialable_to_renew--         , r.contracts_within_renewal AS contracts_within_renewal--         , ufr.upsells_within_subscription AS upsells_avaialable_to_renew--         , r.upsells_within_renewal AS upsells_within_renewal        , CASE WHEN ufr.dollars_up_for_renewal > 0 THEN TRUE ELSE FALSE END AS is_up_for_renewal        , CASE WHEN r.dollars_renewed > 0 THEN TRUE ELSE FALSE END AS is_renewal_booking    FROM monthly_up_for_renewal ufr    CROSS JOIN monthly_actual_renewals r          ON r.renewal_month = ufr.up_for_renewal_month        AND r.is_smb_migration = ufr.is_smb_migration        AND r.first_contact_direction = ufr.first_contact_direction        AND r.industry = ufr.industry    RIGHT JOIN calendar c         ON c.month = ufr.up_for_renewal_month        OR r.renewal_month = c.month-- )-- )